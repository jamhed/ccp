#!/bin/bash
# Archive a solved issue to archive folder

if [ $# -ne 1 ]; then
  echo "Usage: archive <issue-name>"
  exit 1
fi

ISSUE_NAME="$1"
ISSUES_DIR="${ISSUES_DIR:-issues}"
ARCHIVE_DIR="${ARCHIVE_DIR:-archive}"

if [ ! -d "$ISSUES_DIR/$ISSUE_NAME" ]; then
  echo "Issue not found: $ISSUE_NAME"
  exit 1
fi

mkdir -p "$ARCHIVE_DIR"

# Check if issue already exists in archive
TARGET_NAME="$ISSUE_NAME"
if [ -d "$ARCHIVE_DIR/$ISSUE_NAME" ]; then
  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
  TARGET_NAME="${ISSUE_NAME}-${TIMESTAMP}"
  echo "Warning: Issue '$ISSUE_NAME' already exists in archive"
  echo "Archiving as: $TARGET_NAME"
fi

mv "$ISSUES_DIR/$ISSUE_NAME" "$ARCHIVE_DIR/$TARGET_NAME"
echo "Archived: $ISSUE_NAME -> $ARCHIVE_DIR/$TARGET_NAME"

# Execute review hooks if they exist
if [ -d "scripts" ]; then
  REVIEW_HOOKS=(scripts/review-*)
  if [ -e "${REVIEW_HOOKS[0]}" ]; then
    echo "Executing review hooks..."
    for hook in "${REVIEW_HOOKS[@]}"; do
      if [ -x "$hook" ]; then
        echo "Running: $hook $TARGET_NAME"
        "$hook" "$TARGET_NAME"
        HOOK_EXIT=$?
        if [ $HOOK_EXIT -ne 0 ]; then
          echo "Warning: Hook '$hook' exited with code $HOOK_EXIT"
        fi
      fi
    done
  fi
fi

# Git commit and push
echo "Committing and pushing..."

# Stage the moved files (delete from issues, add to archive)
git add "$ISSUES_DIR/$ISSUE_NAME" 2>/dev/null || true
git add "$ARCHIVE_DIR/$TARGET_NAME"

# Create commit
git commit -m "archive: $ISSUE_NAME

Move solved issue to archive folder."

if [ $? -eq 0 ]; then
  echo "Committed: archive $ISSUE_NAME"

  # Push to remote
  git push
  if [ $? -eq 0 ]; then
    echo "Pushed to remote"
  else
    echo "Warning: Failed to push (commit is local)"
  fi
else
  echo "Warning: Nothing to commit or commit failed"
fi
